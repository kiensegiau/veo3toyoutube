# üç™ H∆∞·ªõng d·∫´n t·ª± ƒë·ªông l·∫•y Cookie t·ª´ Chrome Profile

## üìã T·ªïng quan

H·ªá th·ªëng hi·ªán t·∫°i c·ªßa b·∫°n **CH∆ØA** c√≥ t√≠nh nƒÉng t·ª± ƒë·ªông l·∫•y cookie t·ª´ Chrome profile. Hi·ªán t·∫°i ch·ªâ c√≥ th·ªÉ:
1. L·∫•y cookie th·ªß c√¥ng t·ª´ DevTools
2. Nh·∫≠p cookie qua API endpoint

## üîß C√°ch th√™m t√≠nh nƒÉng t·ª± ƒë·ªông l·∫•y cookie

### **Ph∆∞∆°ng ph√°p 1: S·ª≠ d·ª•ng Puppeteer (Khuy·∫øn ngh·ªã)**

```javascript
// Th√™m v√†o chrome-profile-utils.js
const puppeteer = require('puppeteer-core');

/**
 * T·ª± ƒë·ªông l·∫•y cookies t·ª´ Chrome profile
 */
async function extractCookiesFromProfile(profileName = 'Default') {
    try {
        const profilePath = path.join(this.profileManager.defaultProfilePath, profileName);
        
        const launchOptions = this.profileManager.getStealthLaunchOptions({
            profilePath: profilePath,
            headless: 'new'
        });

        const browser = await puppeteer.launch(launchOptions);
        const page = await browser.newPage();
        
        // ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn Google Labs
        await page.goto('https://labs.google', { waitUntil: 'networkidle2' });
        
        // L·∫•y cookies t·ª´ page
        const cookies = await page.cookies();
        
        // Chuy·ªÉn ƒë·ªïi cookies th√†nh string format
        const cookieString = cookies
            .filter(cookie => cookie.domain.includes('labs.google') || cookie.domain.includes('.google.com'))
            .map(cookie => `${cookie.name}=${cookie.value}`)
            .join(';');
        
        await browser.close();
        
        console.log(`üç™ Extracted ${cookies.length} cookies from profile ${profileName}`);
        return cookieString;
        
    } catch (error) {
        console.error(`‚ùå Error extracting cookies: ${error.message}`);
        return null;
    }
}
```

### **Ph∆∞∆°ng ph√°p 2: ƒê·ªçc tr·ª±c ti·∫øp t·ª´ Chrome Database**

```javascript
const sqlite3 = require('sqlite3');
const path = require('path');

/**
 * ƒê·ªçc cookies tr·ª±c ti·∫øp t·ª´ Chrome SQLite database
 */
async function extractCookiesFromDatabase(profileName = 'Default') {
    return new Promise((resolve, reject) => {
        const profilePath = path.join(__dirname, 'chrome-profile', profileName);
        const cookiesPath = path.join(profilePath, 'Default', 'Cookies');
        
        if (!fs.existsSync(cookiesPath)) {
            reject(new Error('Cookies database not found'));
            return;
        }
        
        const db = new sqlite3.Database(cookiesPath, sqlite3.OPEN_READONLY);
        
        const query = `
            SELECT name, value, host_key, path, expires_utc, is_secure, is_httponly
            FROM cookies 
            WHERE host_key LIKE '%labs.google%' OR host_key LIKE '%.google.com%'
        `;
        
        db.all(query, [], (err, rows) => {
            if (err) {
                reject(err);
                return;
            }
            
            const cookieString = rows
                .map(row => `${row.name}=${row.value}`)
                .join(';');
            
            db.close();
            resolve(cookieString);
        });
    });
}
```

### **Ph∆∞∆°ng ph√°p 3: S·ª≠ d·ª•ng Chrome DevTools Protocol**

```javascript
/**
 * L·∫•y cookies qua Chrome DevTools Protocol
 */
async function extractCookiesViaDevTools(profileName = 'Default') {
    try {
        const profilePath = path.join(this.profileManager.defaultProfilePath, profileName);
        
        const launchOptions = {
            ...this.profileManager.getStealthLaunchOptions({
                profilePath: profilePath,
                headless: 'new'
            }),
            devtools: true
        };

        const browser = await puppeteer.launch(launchOptions);
        const page = await browser.newPage();
        
        // K·∫øt n·ªëi v·ªõi DevTools
        const client = await page.target().createCDPSession();
        
        // L·∫•y cookies
        const { cookies } = await client.send('Network.getCookies', {
            urls: ['https://labs.google']
        });
        
        const cookieString = cookies
            .map(cookie => `${cookie.name}=${cookie.value}`)
            .join(';');
        
        await browser.close();
        
        return cookieString;
        
    } catch (error) {
        console.error(`‚ùå Error extracting cookies via DevTools: ${error.message}`);
        return null;
    }
}
```

## üöÄ C√°ch t√≠ch h·ª£p v√†o h·ªá th·ªëng hi·ªán t·∫°i

### **1. Th√™m API endpoint m·ªõi**

```javascript
// Th√™m v√†o server.js
app.post('/api/extract-cookies', async (req, res) => {
    try {
        const { profileName = 'Default' } = req.body || {};
        
        // S·ª≠ d·ª•ng Puppeteer method (khuy·∫øn ngh·ªã)
        const cookieString = await profileUtils.extractCookiesFromProfile(profileName);
        
        if (cookieString) {
            // C·∫≠p nh·∫≠t currentCookies
            currentCookies = cookieString;
            saveStorageData();
            
            // C·∫≠p nh·∫≠t cookies.json
            updateCookiesJsonFile(cookieString);
            
            res.json({
                success: true,
                message: 'Cookies extracted successfully',
                cookies: cookieString,
                profileName: profileName
            });
        } else {
            res.status(400).json({
                success: false,
                message: 'Failed to extract cookies'
            });
        }
        
    } catch (error) {
        console.error('‚ùå Extract cookies error:', error);
        res.status(500).json({
            success: false,
            message: 'Error extracting cookies',
            error: error.message
        });
    }
});
```

### **2. Th√™m v√†o ChromeProfileUtils class**

```javascript
// Th√™m v√†o chrome-profile-utils.js
class ChromeProfileUtils {
    // ... existing methods ...
    
    /**
     * T·ª± ƒë·ªông l·∫•y cookies t·ª´ Chrome profile
     */
    async extractCookiesFromProfile(profileName = 'Default') {
        const puppeteer = require('puppeteer-core');
        
        try {
            const profilePath = path.join(this.profileManager.defaultProfilePath, profileName);
            
            if (!fs.existsSync(profilePath)) {
                throw new Error(`Profile ${profileName} not found`);
            }
            
            const launchOptions = this.profileManager.getStealthLaunchOptions({
                profilePath: profilePath,
                headless: 'new'
            });

            const browser = await puppeteer.launch(launchOptions);
            const page = await browser.newPage();
            
            await this.profileManager.applyStealthSettings(page);
            
            // ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn Google Labs
            await page.goto('https://labs.google', { 
                waitUntil: 'networkidle2',
                timeout: 30000 
            });
            
            // Ch·ªù m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o cookies ƒë∆∞·ª£c load
            await page.waitForTimeout(3000);
            
            // L·∫•y cookies t·ª´ page
            const cookies = await page.cookies();
            
            // L·ªçc cookies li√™n quan ƒë·∫øn Google Labs
            const relevantCookies = cookies.filter(cookie => 
                cookie.domain.includes('labs.google') || 
                cookie.domain.includes('.google.com') ||
                cookie.domain.includes('googleapis.com')
            );
            
            // Chuy·ªÉn ƒë·ªïi th√†nh string format
            const cookieString = relevantCookies
                .map(cookie => `${cookie.name}=${cookie.value}`)
                .join(';');
            
            await browser.close();
            
            console.log(`üç™ Extracted ${relevantCookies.length} cookies from profile ${profileName}`);
            console.log(`üç™ Cookie string: ${cookieString.substring(0, 100)}...`);
            
            return cookieString;
            
        } catch (error) {
            console.error(`‚ùå Error extracting cookies from profile ${profileName}:`, error.message);
            return null;
        }
    }
    
    /**
     * Ki·ªÉm tra v√† t·ª± ƒë·ªông l·∫•y cookies n·∫øu c·∫ßn
     */
    async ensureCookiesAvailable(profileName = 'Default') {
        try {
            // Th·ª≠ l·∫•y cookies t·ª´ profile
            const cookieString = await this.extractCookiesFromProfile(profileName);
            
            if (cookieString) {
                return {
                    success: true,
                    cookies: cookieString,
                    source: 'profile'
                };
            } else {
                return {
                    success: false,
                    message: 'No cookies found in profile'
                };
            }
            
        } catch (error) {
            return {
                success: false,
                message: error.message
            };
        }
    }
}
```

### **3. T·ª± ƒë·ªông h√≥a vi·ªác l·∫•y cookies**

```javascript
// Th√™m v√†o server.js - t·ª± ƒë·ªông l·∫•y cookies khi c·∫ßn
async function ensureCookiesAvailable() {
    if (currentCookies) {
        return true; // ƒê√£ c√≥ cookies
    }
    
    console.log('üç™ No cookies available, attempting to extract from profiles...');
    
    try {
        // Th·ª≠ l·∫•y t·ª´ profile Default tr∆∞·ªõc
        const result = await profileUtils.ensureCookiesAvailable('Default');
        
        if (result.success) {
            currentCookies = result.cookies;
            saveStorageData();
            updateCookiesJsonFile(result.cookies);
            console.log('‚úÖ Cookies extracted and saved');
            return true;
        }
        
        // Th·ª≠ c√°c profile kh√°c
        const profiles = profileUtils.listAllProfiles();
        for (const profileName of profiles) {
            if (profileName === 'Default') continue;
            
            const result = await profileUtils.ensureCookiesAvailable(profileName);
            if (result.success) {
                currentCookies = result.cookies;
                saveStorageData();
                updateCookiesJsonFile(result.cookies);
                console.log(`‚úÖ Cookies extracted from profile ${profileName}`);
                return true;
            }
        }
        
        console.log('‚ùå No cookies found in any profile');
        return false;
        
    } catch (error) {
        console.error('‚ùå Error ensuring cookies:', error);
        return false;
    }
}
```

## üìù C√°ch s·ª≠ d·ª•ng

### **1. L·∫•y cookies th·ªß c√¥ng:**
```bash
POST /api/extract-cookies
{
    "profileName": "GoogleLabs"
}
```

### **2. T·ª± ƒë·ªông l·∫•y cookies:**
```javascript
// H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông l·∫•y cookies khi:
// - Kh·ªüi ƒë·ªông server
// - Token h·∫øt h·∫°n
// - G·ªçi API c·∫ßn cookies
```

## ‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng

1. **Chrome ph·∫£i ƒë∆∞·ª£c ƒë√≥ng** khi ƒë·ªçc cookies t·ª´ database
2. **Profile ph·∫£i ƒë√£ ƒëƒÉng nh·∫≠p** Google Labs tr∆∞·ªõc ƒë√≥
3. **C·∫ßn c√†i ƒë·∫∑t sqlite3** n·∫øu d√πng ph∆∞∆°ng ph√°p ƒë·ªçc database:
   ```bash
   npm install sqlite3
   ```
4. **Puppeteer method** l√† an to√†n nh·∫•t v√† khuy·∫øn ngh·ªã s·ª≠ d·ª•ng

## üîÑ Workflow ho√†n ch·ªânh

1. **T·∫°o profile** ‚Üí `POST /api/create-profile`
2. **ƒêƒÉng nh·∫≠p th·ªß c√¥ng** ‚Üí `POST /api/open-profile-login`
3. **T·ª± ƒë·ªông l·∫•y cookies** ‚Üí `POST /api/extract-cookies`
4. **L·∫•y token t·ª´ cookies** ‚Üí `POST /api/get-new-token`
5. **T·ª± ƒë·ªông l√†m m·ªõi** ‚Üí H·ªá th·ªëng t·ª± ƒë·ªông refresh token

H·ªá th·ªëng n√†y s·∫Ω ho√†n to√†n t·ª± ƒë·ªông h√≥a vi·ªác l·∫•y v√† qu·∫£n l√Ω cookies!
